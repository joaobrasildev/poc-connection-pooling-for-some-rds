# ============================================================================
# HAProxy Configuration — L4 TCP Load Balancer
# Simulates AWS NLB for distributing TDS connections across proxy instances.
# ============================================================================

global
    log stdout format raw local0
    maxconn 4096

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 10s
    timeout client  5m
    timeout server  5m
    retries 3

# ──────────────────────────────────────────────────────────────────────────
# Stats page (accessible at http://localhost:8404/stats)
# ──────────────────────────────────────────────────────────────────────────
frontend stats
    mode http
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 5s
    stats admin if TRUE
    http-request use-service prometheus-exporter if { path /metrics }

# ──────────────────────────────────────────────────────────────────────────
# TDS Frontend — Receives connections from coreVMs on port 1433
# ──────────────────────────────────────────────────────────────────────────
frontend tds_frontend
    bind *:1433
    mode tcp
    default_backend tds_proxy_backends

# ──────────────────────────────────────────────────────────────────────────
# TDS Backend — Distributes to proxy instances
# Uses least-connections algorithm for better distribution
# ──────────────────────────────────────────────────────────────────────────
backend tds_proxy_backends
    mode tcp
    balance leastconn
    option tcp-check

    # Health check via HTTP health endpoint
    option httpchk GET /health/live
    http-check expect status 200

    # Proxy instances
    # TDS traffic goes to port 1433, health checks on port 8080
    server proxy-1 proxy-1:1433 check port 8080 inter 5s fall 3 rise 2
    server proxy-2 proxy-2:1433 check port 8080 inter 5s fall 3 rise 2
    server proxy-3 proxy-3:1433 check port 8080 inter 5s fall 3 rise 2
